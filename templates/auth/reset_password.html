{% extends "base.html" %}

{% block title %}Reset Password - TokenGuard{% endblock %}

{% block content %}
<div class="auth-container">
    <div class="auth-card">
        <div class="auth-header">
            <h1>Reset Password</h1>
            <p>Enter your new password below</p>
        </div>

        <form id="resetPasswordForm" class="auth-form">
            <div class="form-group">
                <label for="password">New Password</label>
                <input 
                    type="password" 
                    id="password" 
                    name="password" 
                    required 
                    autocomplete="new-password"
                    placeholder="Enter new password"
                >
                <div id="passwordError" class="form-message"></div>
                <div id="passwordStrength" class="form-message"></div>
                <div id="passwordSuggestions" class="form-suggestions"></div>
            </div>

            <div class="form-group">
                <label for="confirmPassword">Confirm Password</label>
                <input 
                    type="password" 
                    id="confirmPassword" 
                    name="confirmPassword" 
                    required 
                    autocomplete="new-password"
                    placeholder="Confirm new password"
                >
                <div id="confirmPasswordError" class="form-message"></div>
            </div>

            <button type="submit" id="submitBtn" class="btn btn-primary btn-full">
                <span class="btn-text">Reset Password</span>
            </button>
        </form>

        <div class="auth-footer">
            <p>Remember your password? <a href="{{ url_for('auth.login') }}">Sign In</a></p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/common.js') }}"></script>
<script src="{{ url_for('static', filename='js/auth.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('resetPasswordForm');
    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('confirmPassword');
    const submitBtn = document.getElementById('submitBtn');

    // Password strength checking
    const checkPasswordStrength = debounce(() => {
        const password = passwordInput.value;
        const strengthElement = document.getElementById('passwordStrength');
        const suggestionsElement = document.getElementById('passwordSuggestions');
        
        if (!strengthElement) return;
        
        const validation = validatePassword(password);
        
        // Update strength display
        strengthElement.textContent = validation.message;
        strengthElement.className = `form-message ${getStrengthClass(validation.strength)}`;
        
        // Show suggestions if password is weak
        if (validation.suggestions.length > 0) {
            suggestionsElement.innerHTML = validation.suggestions.map(s => `<li>${s}</li>`).join('');
        }
    }, 200);

    // Password confirmation validation
    const validatePasswordMatch = () => {
        const password = passwordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        const errorElement = document.getElementById('confirmPasswordError');
        
        if (!password || !confirmPassword) {
            errorElement.textContent = '';
            return true;
        }
        
        if (password !== confirmPassword) {
            errorElement.textContent = 'Passwords do not match';
            errorElement.className = 'form-message error';
            return false;
        }
        
        errorElement.textContent = '';
        errorElement.className = 'form-message';
        return true;
    };

    // Get strength class
    function getStrengthClass(strength) {
        if (strength <= 2) return 'error';
        if (strength === 3) return 'warning';
        return 'success';
    }

    // Event listeners
    passwordInput.addEventListener('input', checkPasswordStrength);
    confirmPasswordInput.addEventListener('blur', validatePasswordMatch);
    
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Validate passwords match
        if (!validatePasswordMatch()) {
            return;
        }
        
        // Validate password strength
        const password = passwordInput.value;
        const validation = validatePassword(password);
        if (!validation.isValid) {
            const errorElement = document.getElementById('passwordError');
            errorElement.textContent = validation.message;
            errorElement.className = 'form-message error';
            return;
        }
        
        // Clear previous errors
        document.getElementById('passwordError').textContent = '';
        
        // Set loading state
        submitBtn.disabled = true;
        submitBtn.classList.add('loading');
        
        try {
            const response = await fetch(window.location.pathname, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    password: password
                })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                // Show success message
                showMessage(data.message || 'Password reset successful!', 'success');
                
                // Redirect to login after delay
                setTimeout(() => {
                    window.location.href = '{{ url_for("auth.login") }}';
                }, 2000);
            } else {
                showMessage(data.error || 'Password reset failed', 'error');
            }
        } catch (error) {
            console.error('Password reset error:', error);
            showMessage('Password reset failed. Please try again.', 'error');
        } finally {
            // Reset loading state
            submitBtn.disabled = false;
            submitBtn.classList.remove('loading');
        }
    });
    
    // Message display function
    function showMessage(message, type = 'info') {
        const messageElement = document.getElementById('message');
        if (messageElement) {
            messageElement.textContent = message;
            messageElement.className = `message ${type}`;
            messageElement.style.display = 'block';
            
            setTimeout(() => {
                messageElement.style.display = 'none';
            }, 5000);
        }
    }
});
</script>
{% endblock %}
