{% extends "base.html" %}

{% block title %}API Logs - {{ user.email }}{% endblock %}
{% block body_class %}logs-page{% endblock %}

{% block extra_css %}
<style>
    .stats-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        text-align: center;
    }
    
    .stat-number {
        font-size: 24px;
        font-weight: bold;
        color: #667eea;
        margin-bottom: 5px;
    }
    
    .stat-label {
        color: #666;
        font-size: 14px;
    }
    
    .filters-section {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin-bottom: 15px;
    }
    
    .filter-group {
        display: flex;
        flex-direction: column;
    }
    
    .filter-label {
        font-weight: 600;
        margin-bottom: 5px;
        color: #333;
    }
    
    .filter-input {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
    }
    
    .filter-buttons {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }
    
    .logs-table-container {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .logs-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .logs-table th {
        background: #f8f9fa;
        padding: 15px 12px;
        text-align: left;
        font-weight: 600;
        color: #333;
        border-bottom: 2px solid #e9ecef;
    }
    
    .logs-table td {
        padding: 12px;
        border-bottom: 1px solid #e9ecef;
        vertical-align: top;
    }
    
    .logs-table tr:hover {
        background: #f8f9fa;
    }
    
    .status-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .status-pass {
        background: #d4edda;
        color: #155724;
    }
    
    .status-error {
        background: #f8d7da;
        color: #721c24;
    }
    
    .api-key-display {
        font-family: monospace;
        font-size: 12px;
        background: #f8f9fa;
        padding: 4px 6px;
        border-radius: 4px;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .request-body {
        max-width: 300px;
        font-family: monospace;
        font-size: 12px;
        background: #f8f9fa;
        padding: 6px;
        border-radius: 4px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-top: 20px;
        padding: 20px;
    }
    
    .pagination button {
        padding: 8px 12px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .pagination button:hover:not(:disabled) {
        background: #f8f9fa;
    }
    
    .pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .loading {
        text-align: center;
        padding: 40px;
        color: #666;
    }
    
    .no-logs {
        text-align: center;
        padding: 40px;
        color: #666;
    }
    
    .error-message {
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
    <div class="keys-container">
        <!-- Header Section -->
        <div class="keys-header">
            <div class="header-content">
                <h1>üìä API Usage Logs</h1>
                <div class="user-info">
                    <span class="user-email">{{ user.email }}</span>
                    <span class="user-id">ID: {{ user.user_id }}</span>
                </div>
            </div>
            <div class="header-actions">
                <a href="{{ url_for('main.user_profile', user_id=user.user_id) }}" class="btn btn-secondary">Back to Profile</a>
                <a href="{{ url_for('auth.logout') }}" class="btn btn-primary">Logout</a>
            </div>
        </div>
        
        <!-- Stats Summary -->
        <div class="stats-summary" id="statsSummary">
            <div class="stat-card">
                <div class="stat-number" id="totalCalls">-</div>
                <div class="stat-label">Total Calls</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="successfulCalls">-</div>
                <div class="stat-label">Successful</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="failedCalls">-</div>
                <div class="stat-label">Failed</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgResponseTime">-</div>
                <div class="stat-label">Avg Response (ms)</div>
            </div>
        </div>
        
        <!-- Filters -->
        <div class="filters-section">
            <h3>üîç Filter Logs</h3>
            <div class="filters-grid">
                <div class="filter-group">
                    <label class="filter-label">API Key</label>
                    <select class="filter-input" id="apiKeyFilter">
                        <option value="">All API Keys</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Status</label>
                    <select class="filter-input" id="statusFilter">
                        <option value="">All Statuses</option>
                        <option value="key_pass">Success</option>
                        <option value="key_error">Error</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Start Date</label>
                    <input type="datetime-local" class="filter-input" id="startDateFilter">
                </div>
                <div class="filter-group">
                    <label class="filter-label">End Date</label>
                    <input type="datetime-local" class="filter-input" id="endDateFilter">
                </div>
            </div>
            <div class="filter-buttons">
                <button class="btn btn-secondary" onclick="clearFilters()">Clear Filters</button>
                <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
            </div>
        </div>
        
        <!-- Logs Table -->
        <div class="excel-table-container">
            <div class="table-toolbar">
                <div class="table-info">
                    <span class="record-count" id="recordCount">Loading logs...</span>
                    <span class="help-text">üí° Monitor your API key usage and performance</span>
                </div>
            </div>
            
            <div class="excel-table-wrapper">
                <div id="logsContent">
                    <div class="loading">Loading logs...</div>
                </div>
            </div>
        </div>
        
        <!-- Pagination -->
        <div class="pagination" id="pagination" style="display: none;">
            <button id="prevPage" onclick="changePage(-1)">Previous</button>
            <span id="pageInfo">Page 1 of 1</span>
            <button id="nextPage" onclick="changePage(1)">Next</button>
        </div>
    </div>
    
{% endblock %}

{% block scripts %}
        let currentPage = 1;
        let pageSize = 50;
        let totalPages = 1;
        let currentFilters = {};
        
        // Load stats on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            loadLogs();
            loadApiKeys();
        });
        
        async function loadStats() {
            try {
                const response = await fetch('/api/logs/stats?days=30');
                const data = await response.json();
                
                if (data.stats) {
                    document.getElementById('totalCalls').textContent = data.stats.total_calls;
                    document.getElementById('successfulCalls').textContent = data.stats.successful_calls;
                    document.getElementById('failedCalls').textContent = data.stats.failed_calls;
                    document.getElementById('avgResponseTime').textContent = data.stats.avg_processing_time;
                }
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }
        
        async function loadApiKeys() {
            try {
                const response = await fetch('/api/session-debug');
                const data = await response.json();
                
                const select = document.getElementById('apiKeyFilter');
                select.innerHTML = '<option value="">All API Keys</option>';
                
                if (data.api_keys) {
                    data.api_keys.forEach(key => {
                        const option = document.createElement('option');
                        option.value = key.key_value;
                        option.textContent = `${key.key_name} (${key.key_value.substring(0, 8)}...)`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Failed to load API keys:', error);
            }
        }
        
        async function loadLogs() {
            try {
                document.getElementById('logsContent').innerHTML = '<div class="loading">Loading logs...</div>';
                
                const params = new URLSearchParams({
                    limit: pageSize,
                    offset: (currentPage - 1) * pageSize,
                    ...currentFilters
                });
                
                const response = await fetch(`/api/logs?${params}`);
                const data = await response.json();
                
                if (data.error) {
                    document.getElementById('logsContent').innerHTML = 
                        `<div class="error-message">Error: ${data.error}</div>`;
                    return;
                }
                
                displayLogs(data.logs);
                updatePagination(data.count);
                
            } catch (error) {
                console.error('Failed to load logs:', error);
                document.getElementById('logsContent').innerHTML = 
                    '<div class="error-message">Failed to load logs. Please try again.</div>';
            }
        }
        
        function displayLogs(logs) {
            // Update record count
            document.getElementById('recordCount').textContent = `${logs.length} Log Entries`;
            
            if (logs.length === 0) {
                document.getElementById('logsContent').innerHTML = 
                    '<div class="no-logs">No logs found matching your criteria.</div>';
                return;
            }
            
            const table = document.createElement('table');
            table.className = 'excel-table';
            
            // Table header
            const header = table.createTHead();
            const headerRow = header.insertRow();
            const headers = [
                { text: 'Timestamp', class: 'col-timestamp' },
                { text: 'API Key', class: 'col-key' },
                { text: 'Status', class: 'col-status' },
                { text: 'Request Body', class: 'col-request' },
                { text: 'Response', class: 'col-response' },
                { text: 'Processing Time', class: 'col-time' }
            ];
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header.text;
                th.className = header.class;
                headerRow.appendChild(th);
            });
            
            // Table body
            const tbody = table.createTBody();
            logs.forEach((log, index) => {
                const row = tbody.insertRow();
                row.className = 'data-row';
                
                // Timestamp
                const timestamp = new Date(log.request_timestamp).toLocaleString();
                const timestampCell = row.insertCell();
                timestampCell.className = 'col-timestamp';
                timestampCell.textContent = timestamp;
                
                // API Key
                const keyCell = row.insertCell();
                keyCell.className = 'col-key';
                const keySpan = document.createElement('span');
                keySpan.className = 'api-key-display';
                keySpan.textContent = log.api_key_value;
                keySpan.title = log.api_key_value;
                keyCell.appendChild(keySpan);
                
                // Status
                const statusCell = row.insertCell();
                statusCell.className = 'col-status';
                const statusSpan = document.createElement('span');
                statusSpan.className = `status-badge status-${log.response_status === 'key_pass' ? 'pass' : 'error'}`;
                statusSpan.textContent = log.response_status === 'key_pass' ? 'Success' : 'Error';
                statusCell.appendChild(statusSpan);
                
                // Request Body
                const requestCell = row.insertCell();
                requestCell.className = 'col-request';
                const requestSpan = document.createElement('span');
                requestSpan.className = 'request-body';
                requestSpan.textContent = log.request_body || 'N/A';
                requestSpan.title = log.request_body || 'N/A';
                requestCell.appendChild(requestSpan);
                
                // Response
                const responseCell = row.insertCell();
                responseCell.className = 'col-response';
                const responseSpan = document.createElement('span');
                responseSpan.className = 'request-body';
                responseSpan.textContent = log.response_body || 'N/A';
                responseSpan.title = log.response_body || 'N/A';
                responseCell.appendChild(responseSpan);
                
                // Processing Time
                const timeCell = row.insertCell();
                timeCell.className = 'col-time';
                timeCell.textContent = log.processing_time_ms ? `${log.processing_time_ms}ms` : 'N/A';
            });
            
            document.getElementById('logsContent').innerHTML = '';
            document.getElementById('logsContent').appendChild(table);
        }
        
        function updatePagination(count) {
            totalPages = Math.ceil(count / pageSize);
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }
            
            pagination.style.display = 'flex';
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
            document.getElementById('prevPage').disabled = currentPage <= 1;
            document.getElementById('nextPage').disabled = currentPage >= totalPages;
        }
        
        function changePage(direction) {
            const newPage = currentPage + direction;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                loadLogs();
            }
        }
        
        function applyFilters() {
            currentFilters = {};
            
            const apiKey = document.getElementById('apiKeyFilter').value;
            if (apiKey) currentFilters.api_key = apiKey;
            
            const status = document.getElementById('statusFilter').value;
            if (status) currentFilters.status = status;
            
            const startDate = document.getElementById('startDateFilter').value;
            if (startDate) currentFilters.start_date = new Date(startDate).toISOString();
            
            const endDate = document.getElementById('endDateFilter').value;
            if (endDate) currentFilters.end_date = new Date(endDate).toISOString();
            
            currentPage = 1;
            loadLogs();
        }
        
        function clearFilters() {
            document.getElementById('apiKeyFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('startDateFilter').value = '';
            document.getElementById('endDateFilter').value = '';
            
            currentFilters = {};
            currentPage = 1;
            loadLogs();
        }
{% endblock %}
